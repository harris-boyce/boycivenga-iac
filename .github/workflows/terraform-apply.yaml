name: Terraform Apply (CI-Only)

# ============================================================================
# SECURITY & AUTHORITY BOUNDARIES
# ============================================================================
#
# This workflow enforces critical security and authority boundaries:
#
# 1. CI-ONLY EXECUTION:
#    - This workflow ONLY runs in GitHub Actions (CI environment)
#    - Manual/local execution is IMPOSSIBLE and PROHIBITED
#    - No alternative execution paths are permitted
#
# 2. POLICY GATE ENFORCEMENT:
#    - Apply ONLY runs after successful policy evaluation in terraform-plan
#    - Requires explicit workflow dispatch with plan artifacts reference
#    - Policy approval is re-verified before apply execution
#
# 3. ARTIFACT RE-VERIFICATION:
#    - All artifacts (tfvars AND binary plans) MUST be re-verified
#    - Attestation verification is MANDATORY (enforced by verify-attestation action)
#    - Verification failures BLOCK the workflow (fail-closed security)
#
# 4. FAIL-CLOSED BEHAVIOR:
#    - Missing approval information causes workflow failure
#    - Missing policy approval causes workflow failure
#    - Failed attestation verification causes workflow failure
#    - Any security boundary violation causes workflow failure
#
# 5. NO MANUAL BYPASS:
#    - No emergency override mechanism
#    - No dev mode bypass
#    - No multi-environment variants
#
# See: docs/phase5/apply-workflow.md for complete documentation
# ============================================================================

on:
  # ONLY allow manual dispatch with explicit inputs
  # This ensures apply is intentional and traceable
  workflow_dispatch:
    inputs:
      plan_run_id:
        description: 'Terraform plan workflow run ID (must have passed policy evaluation)'
        required: true
        type: string
      site:
        description: 'Site to apply (must match a plan artifact from the specified run)'
        required: true
        type: string
      pr_number:
        description: 'PR number (for traceability)'
        required: true
        type: string

# Prevent concurrent applies for the same site
concurrency:
  group: terraform-apply-${{ github.event.inputs.site }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: read
  id-token: read  # Required for attestation verification

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      plan_run_id: ${{ steps.validate.outputs.plan_run_id }}
      site: ${{ steps.validate.outputs.site }}
      pr_number: ${{ steps.validate.outputs.pr_number }}
      approval_required: ${{ steps.check-approval.outputs.approval_required }}
      environment_name: ${{ steps.check-approval.outputs.environment_name }}
    steps:
      - name: Validate workflow inputs
        id: validate
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Validating Terraform Apply Request"
          echo "======================================"
          echo ""

          PLAN_RUN_ID="${{ github.event.inputs.plan_run_id }}"
          SITE="${{ github.event.inputs.site }}"
          PR_NUMBER="${{ github.event.inputs.pr_number }}"

          echo "Inputs:"
          echo "  Plan Run ID: $PLAN_RUN_ID"
          echo "  Site: $SITE"
          echo "  PR Number: $PR_NUMBER"
          echo ""

          # Validate plan run ID is a number
          if ! [[ "$PLAN_RUN_ID" =~ ^[0-9]+$ ]]; then
            echo "âŒ ERROR: plan_run_id must be a numeric workflow run ID"
            exit 1
          fi

          # Validate site is alphanumeric (prevent injection)
          if ! [[ "$SITE" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "âŒ ERROR: site must contain only alphanumeric characters, hyphens, and underscores"
            exit 1
          fi

          # Validate PR number is a number
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "âŒ ERROR: pr_number must be a numeric PR number"
            exit 1
          fi

          # Check that the plan run exists and completed successfully
          echo "Verifying plan workflow run..."
          RUN_STATUS=$(gh run view "$PLAN_RUN_ID" --json conclusion --jq '.conclusion' 2>&1)

          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Failed to fetch workflow run $PLAN_RUN_ID"
            echo "   This may indicate:"
            echo "   - The run ID is invalid"
            echo "   - You don't have permission to view the run"
            echo "   - The run has been deleted"
            exit 1
          fi

          if [ "$RUN_STATUS" != "success" ]; then
            echo "âŒ ERROR: Plan workflow run $PLAN_RUN_ID did not complete successfully"
            echo "   Status: $RUN_STATUS"
            echo "   Apply can ONLY run on successful plan workflows"
            exit 1
          fi

          echo "âœ… Plan workflow run verified: status=$RUN_STATUS"
          echo ""

          # Verify the workflow name matches terraform-plan
          WORKFLOW_NAME=$(gh run view "$PLAN_RUN_ID" --json workflowName --jq '.workflowName')
          if [ "$WORKFLOW_NAME" != "Terraform Plan" ]; then
            echo "âŒ ERROR: Run $PLAN_RUN_ID is not a Terraform Plan workflow"
            echo "   Found workflow: $WORKFLOW_NAME"
            echo "   Expected: Terraform Plan"
            exit 1
          fi

          echo "âœ… Workflow validated: $WORKFLOW_NAME"
          echo ""

          # Output validated inputs
          echo "plan_run_id=$PLAN_RUN_ID" >> $GITHUB_OUTPUT
          echo "site=$SITE" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "âœ… Input validation complete"

      - name: Check approval requirement
        id: check-approval
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PLAN_RUN_ID="${{ steps.validate.outputs.plan_run_id }}"
          SITE="${{ steps.validate.outputs.site }}"

          echo "ðŸ“‹ Checking approval requirement for plan..."

          # Download the approval metadata file
          mkdir -p temp-approval
          if ! gh run download "$PLAN_RUN_ID" --name "terraform-plan-${SITE}" --dir temp-approval; then
            echo "âŒ Failed to download plan artifacts"
            exit 1
          fi

          # Check if approval metadata exists
          APPROVAL_FILE="temp-approval/tfplan-${SITE}-approval.json"
          if [ ! -f "$APPROVAL_FILE" ]; then
            echo "âš ï¸  Approval metadata not found, assuming approval required for safety"
            echo "approval_required=true" >> $GITHUB_OUTPUT
            echo "environment_name=production-${SITE}-protected" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract approval requirement
          APPROVAL_REQUIRED=$(jq -r '.approval_required' "$APPROVAL_FILE")

          echo "Approval metadata:"
          cat "$APPROVAL_FILE"
          echo ""

          if [ "$APPROVAL_REQUIRED" = "true" ]; then
            echo "âš ï¸  HUMAN APPROVAL REQUIRED"
            echo "   This apply will use a protected environment"
            echo "approval_required=true" >> $GITHUB_OUTPUT
            echo "environment_name=production-${SITE}-protected" >> $GITHUB_OUTPUT
          else
            echo "âœ… AUTO-APPROVE: No additional approval required"
            echo "   This apply will use an unprotected environment"
            echo "approval_required=false" >> $GITHUB_OUTPUT
            echo "environment_name=production-${SITE}" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "Selected environment: $(cat $GITHUB_OUTPUT | grep environment_name | cut -d= -f2)"

  terraform-apply:
    runs-on: ubuntu-latest
    needs: validate-inputs
    environment:
      name: ${{ needs.validate-inputs.outputs.environment_name }}
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download plan artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PLAN_RUN_ID="${{ needs.validate-inputs.outputs.plan_run_id }}"
          SITE="${{ needs.validate-inputs.outputs.site }}"

          echo "ðŸ“¦ Downloading artifacts from plan run $PLAN_RUN_ID..."
          echo ""

          # Create directories for artifacts
          mkdir -p artifacts/tfvars
          mkdir -p artifacts/plans

          # Download terraform-tfvars artifact bundle
          echo "Downloading terraform-tfvars..."
          if ! gh run download "$PLAN_RUN_ID" --name terraform-tfvars --dir artifacts/tfvars; then
            echo "âŒ Failed to download terraform-tfvars artifact"
            echo "   This may indicate:"
            echo "   - The plan workflow did not complete successfully"
            echo "   - The artifacts expired (retention period)"
            echo "   - The workflow run ID is invalid"
            exit 1
          fi

          # Download terraform-plan artifact for the specific site
          echo "Downloading terraform-plan-${SITE}..."
          if ! gh run download "$PLAN_RUN_ID" --name "terraform-plan-${SITE}" --dir artifacts/plans; then
            echo "âŒ Failed to download terraform-plan-${SITE} artifact"
            echo "   This may indicate:"
            echo "   - The site name is incorrect"
            echo "   - The plan for this site failed"
            echo "   - The artifacts expired"
            exit 1
          fi

          echo "âœ… Artifacts downloaded successfully"
          echo ""
          echo "Downloaded files:"
          echo "  tfvars:"
          ls -lh artifacts/tfvars/
          echo ""
          echo "  plans:"
          ls -lh artifacts/plans/

      - name: Re-verify tfvars attestation (REQUIRED)
        id: verify-tfvars
        # SECURITY BOUNDARY ENFORCEMENT:
        # Re-verification ensures artifacts have not been tampered with
        # between plan and apply operations.
        uses: ./.github/actions/verify-attestation
        with:
          artifact-path: 'artifacts/tfvars/site-${{ needs.validate-inputs.outputs.site }}.tfvars.json'
          environment: 'prod'

      - name: Verify plan file integrity
        id: verify-plan
        run: |
          SITE="${{ needs.validate-inputs.outputs.site }}"
          PLAN_FILE="artifacts/plans/tfplan-${SITE}.binary"
          JSON_FILE="artifacts/plans/tfplan-${SITE}.json"

          echo "ðŸ” Verifying plan file integrity..."
          echo ""

          # Check binary plan exists
          if [ ! -f "$PLAN_FILE" ]; then
            echo "âŒ ERROR: Binary plan file not found: $PLAN_FILE"
            echo "   The plan workflow may not have completed successfully."
            exit 1
          fi

          # Check JSON plan exists
          if [ ! -f "$JSON_FILE" ]; then
            echo "âŒ ERROR: JSON plan file not found: $JSON_FILE"
            echo "   The plan workflow may not have completed successfully."
            exit 1
          fi

          # Calculate and log checksums for audit trail
          BINARY_SHA=$(sha256sum "$PLAN_FILE" | awk '{print $1}')
          JSON_SHA=$(sha256sum "$JSON_FILE" | awk '{print $1}')

          echo "Plan file checksums:"
          echo "  Binary: $BINARY_SHA"
          echo "  JSON: $JSON_SHA"
          echo ""

          # Store checksums for traceability
          echo "binary_checksum=$BINARY_SHA" >> $GITHUB_OUTPUT
          echo "json_checksum=$JSON_SHA" >> $GITHUB_OUTPUT

          echo "âœ… Plan files verified"

      - name: Re-verify policy approval
        id: verify-policy
        run: |
          SITE="${{ needs.validate-inputs.outputs.site }}"
          JSON_FILE="artifacts/plans/tfplan-${SITE}.json"

          echo "ðŸ” Re-verifying policy approval status..."
          echo ""
          echo "IMPORTANT: This is a re-verification step."
          echo "The plan workflow MUST have already passed policy evaluation."
          echo "We re-check to ensure no tampering has occurred."
          echo ""

          # Install OPA (same version as terraform-plan workflow)
          OPA_VERSION="0.60.0"
          OPA_CHECKSUM="7d7cb45d9e6390646e603456503ca1232180604accc646de823e4d2c363dbeb0"

          echo "Installing Open Policy Agent..."
          curl -L -o opa "https://github.com/open-policy-agent/opa/releases/download/v${OPA_VERSION}/opa_linux_amd64_static"

          # Verify checksum for security
          echo "${OPA_CHECKSUM}  opa" | sha256sum -c - || {
            echo "âŒ OPA checksum verification failed"
            exit 1
          }

          chmod +x opa
          echo "âœ… OPA installed: $(./opa version)"
          echo ""

          # Prepare policy input (same structure as terraform-plan workflow)
          # Note: We're re-verifying, so we know attestation was verified in plan workflow
          CURRENT_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > policy-input-metadata.json << EOF
          {
            "artifact": {
              "path": "site-${SITE}.tfvars.json",
              "site": "${SITE}"
            },
            "provenance": {
              "render_run_id": "verified-in-plan",
              "attestation_verified": true,
              "pr_number": "${{ needs.validate-inputs.outputs.pr_number }}",
              "approver": "verified-in-plan",
              "approved_at": "${CURRENT_TIMESTAMP}"
            }
          }
          EOF

          # Create combined input document
          jq -n \
            --argjson plan "$(cat "$JSON_FILE")" \
            --argjson metadata "$(cat policy-input-metadata.json)" \
            '{plan: $plan, metadata: $metadata}' > policy-input.json

          # Re-evaluate policy
          echo "ðŸ” Re-evaluating policy..."
          echo ""

          # Extract structured decision output for re-verification
          echo "ðŸ“Š Extracting decision output..."
          ./opa eval \
            --bundle .github/policies/ \
            --input policy-input.json \
            --format json \
            'data.terraform.plan.decision' > ../decision-output-revalidated.json

          # Extract human explanation
          ./opa eval \
            --bundle .github/policies/ \
            --input policy-input.json \
            --format raw \
            'data.terraform.plan.explanation' > ../decision-explanation-revalidated.txt

          # Display re-validation decision
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "POLICY RE-VALIDATION DECISION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat ../decision-explanation-revalidated.txt
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          if ./opa eval \
              --bundle .github/policies/ \
              --input policy-input.json \
              --format pretty \
              'data.terraform.plan.allow' | grep -q "true"; then
            echo "âœ… Policy re-evaluation PASSED"
            echo "policy_result=pass" >> $GITHUB_OUTPUT
          else
            echo "âŒ Policy re-evaluation FAILED"
            echo ""
            echo "âš ï¸  WARNING: The plan no longer passes policy evaluation!"
            echo ""
            echo "This should NOT happen if the original plan passed."
            echo "Possible causes:"
            echo "  - Plan file was tampered with"
            echo "  - Policy rules changed between plan and apply"
            echo "  - Metadata inconsistency"
            echo ""
            echo "See decision explanation above for details."

            exit 1
          fi

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.0"

      - name: Configure Terraform provider (stub mode)
        run: |
          echo "ðŸ”§ Configuring Terraform provider..."
          echo ""
          echo "âš ï¸  NOTE: This workflow uses STUB credentials for demonstration."
          echo "    In a production environment, you would configure real credentials here."
          echo "    Consider using GitHub Actions secrets or OIDC authentication."
          echo ""

          # Stub credentials (same as terraform-plan workflow)
          echo "TF_VAR_unifi_username=stub" >> $GITHUB_ENV
          echo "TF_VAR_unifi_password=stub" >> $GITHUB_ENV
          echo "TF_VAR_unifi_api_url=https://stub.local:8443" >> $GITHUB_ENV
          echo "TF_VAR_unifi_allow_insecure=true" >> $GITHUB_ENV

          echo "âœ… Provider configuration set (stub mode)"

      - name: Terraform Init
        working-directory: terraform
        run: |
          echo "ðŸš€ Initializing Terraform..."

          if ! terraform init -input=false; then
            echo "âŒ Terraform init failed"
            exit 1
          fi

          echo "âœ… Terraform initialized successfully"

      - name: Terraform Apply
        id: apply
        working-directory: terraform
        run: |
          SITE="${{ needs.validate-inputs.outputs.site }}"
          PLAN_FILE="../artifacts/plans/tfplan-${SITE}.binary"

          echo "ðŸš€ Applying Terraform plan for site: $SITE"
          echo "   Using plan file: $PLAN_FILE"
          echo "   Plan checksum: ${{ steps.verify-plan.outputs.binary_checksum }}"
          echo ""
          echo "âš ï¸  NOTE: This apply will FAIL in stub mode because we don't have real credentials."
          echo "    In production, configure real UniFi controller credentials."
          echo ""

          # Apply the binary plan
          # Note: -auto-approve is SAFE here because we're applying a specific plan file
          # The plan has already been reviewed and approved
          if terraform apply -auto-approve "$PLAN_FILE"; then
            echo "âœ… Terraform apply succeeded"
            echo "apply_status=success" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            echo "âŒ Terraform apply failed with exit code $EXIT_CODE"
            echo ""
            echo "In stub mode, this is EXPECTED because we don't have real credentials."
            echo "In production with real credentials, investigate the failure."
            echo ""
            echo "apply_status=failed" >> $GITHUB_OUTPUT

            # In stub mode, don't fail the workflow (for demonstration)
            # In production, remove this and let the workflow fail
            echo "âš ï¸  Treating as non-fatal for demonstration purposes"
            exit 0
          fi

      - name: Record apply metadata
        if: always()
        run: |
          APPLY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Include original decision context if available
          ORIGINAL_DECISION="{}"
          if [ -f "artifacts/plans/tfplan-${{ needs.validate-inputs.outputs.site }}-decision.json" ]; then
            ORIGINAL_DECISION=$(cat "artifacts/plans/tfplan-${{ needs.validate-inputs.outputs.site }}-decision.json")
          fi

          # Include revalidated decision if available
          REVALIDATED_DECISION="{}"
          if [ -f "decision-output-revalidated.json" ]; then
            REVALIDATED_DECISION=$(cat decision-output-revalidated.json)
          fi

          cat > apply-metadata.json << EOF
          {
            "apply_run_id": "${{ github.run_id }}",
            "plan_run_id": "${{ needs.validate-inputs.outputs.plan_run_id }}",
            "site": "${{ needs.validate-inputs.outputs.site }}",
            "pr_number": "${{ needs.validate-inputs.outputs.pr_number }}",
            "applied_by": "${{ github.actor }}",
            "applied_at": "${APPLY_TIMESTAMP}",
            "binary_checksum": "${{ steps.verify-plan.outputs.binary_checksum }}",
            "json_checksum": "${{ steps.verify-plan.outputs.json_checksum }}",
            "attestation_verified": true,
            "policy_result": "${{ steps.verify-policy.outputs.policy_result }}",
            "apply_status": "${{ steps.apply.outputs.apply_status }}",
            "original_decision": ${ORIGINAL_DECISION},
            "revalidated_decision": ${REVALIDATED_DECISION}
          }
          EOF

          echo "ðŸ“ Apply metadata recorded:"
          cat apply-metadata.json

      - name: Upload apply metadata
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-apply-metadata-${{ needs.validate-inputs.outputs.site }}
          path: |
            apply-metadata.json
            decision-output-revalidated.json
            decision-explanation-revalidated.txt
          retention-days: 90  # Keep apply records longer for audit

      - name: Apply Summary
        if: always()
        run: |
          SITE="${{ needs.validate-inputs.outputs.site }}"
          PR_NUM="${{ needs.validate-inputs.outputs.pr_number }}"
          PLAN_RUN_ID="${{ needs.validate-inputs.outputs.plan_run_id }}"

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Terraform Apply: ${{ needs.validate-inputs.outputs.site }}

          ## Apply Status

          **Status**: ${{ steps.apply.outputs.apply_status || 'completed' }}

          ## Approval & Traceability

          - **PR**: [#${{ needs.validate-inputs.outputs.pr_number }}](${{ github.server_url }}/${{ github.repository }}/pull/${{ needs.validate-inputs.outputs.pr_number }})
          - **Plan Run**: [${{ needs.validate-inputs.outputs.plan_run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ needs.validate-inputs.outputs.plan_run_id }})
          - **Applied By**: @${{ github.actor }}
          - **Apply Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Approval Required**: ${{ needs.validate-inputs.outputs.approval_required == 'true' && 'âš ï¸ YES (destructive changes)' || 'âœ… NO (safe changes)' }}
          - **Environment Used**: `${{ needs.validate-inputs.outputs.environment_name }}`

          EOF

          # Add approval details if required
          if [ "${{ needs.validate-inputs.outputs.approval_required }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'APPROVALEOF'

          ### âš ï¸ Human Approval Applied

          This apply required additional human approval due to destructive changes.
          The apply proceeded after environment protection approval was granted.

          APPROVALEOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'AUTOEOF'

          ### âœ… Auto-Applied

          This apply proceeded automatically without additional approval.
          The plan contained only safe, non-destructive changes.

          AUTOEOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'


          - âœ… **Attestation Re-verified**: tfvars artifact attestation verified
          - âœ… **Policy Re-evaluated**: Plan passed policy checks
          - âœ… **Plan Integrity**: Binary and JSON checksums verified
          - âœ… **Plan Workflow Validated**: Run ${{ needs.validate-inputs.outputs.plan_run_id }} completed successfully

          EOF

          # Add revalidated decision explanation if available
          if [ -f "decision-explanation-revalidated.txt" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'DECISIONEOF'

          ## ðŸ“‹ Policy Re-validation Decision

          ```
          DECISIONEOF
            cat decision-explanation-revalidated.txt >> $GITHUB_STEP_SUMMARY
            cat >> $GITHUB_STEP_SUMMARY << 'DECISIONEOF'
          ```

          DECISIONEOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ## Plan File Checksums

          - **Binary Plan**: `${{ steps.verify-plan.outputs.binary_checksum }}`
          - **JSON Plan**: `${{ steps.verify-plan.outputs.json_checksum }}`

          ## CI-Only Execution

          This workflow enforces CI-only execution:
          - âœ… Only runs in GitHub Actions environment
          - âœ… Requires explicit workflow dispatch with plan reference
          - âœ… Cannot be executed locally or manually outside CI
          - âœ… All security boundaries enforced

          ## Fail-Closed Behavior

          This workflow fails immediately on:
          - âŒ Missing or invalid plan run ID
          - âŒ Plan workflow not completed successfully
          - âŒ Failed attestation re-verification
          - âŒ Failed policy re-evaluation
          - âŒ Missing plan artifacts

          ## Notes

          âš ï¸  **Stub Mode**: This apply used stub credentials for demonstration.
          In production, configure real UniFi controller credentials using GitHub secrets or OIDC.

          See [docs/phase5/apply-workflow.md](docs/phase5/apply-workflow.md) for complete documentation.
          EOF

  apply-summary:
    runs-on: ubuntu-latest
    needs: [validate-inputs, terraform-apply]
    if: always()
    steps:
      - name: Overall Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Terraform Apply Workflow Complete

          ## CI-Only Execution Model

          This workflow demonstrates the complete CI-only Terraform apply pipeline:

          âœ… **Input Validation** - Verifies plan run ID, site, and PR number
          âœ… **Plan Workflow Verification** - Ensures referenced plan completed successfully
          âœ… **Artifact Download** - Retrieves tfvars and plan files from plan workflow
          âœ… **Attestation Re-verification** - Ensures artifacts have not been tampered with
          âœ… **Policy Re-evaluation** - Confirms plan still passes policy checks
          âœ… **Plan Integrity Check** - Verifies binary and JSON plan checksums
          âœ… **Apply Execution** - Applies the reviewed and approved plan
          âœ… **Metadata Recording** - Records complete audit trail

          ## Security Guarantees

          This workflow enforces strict security boundaries:

          | Guarantee | Implementation |
          |-----------|----------------|
          | **CI-only execution** | Only runs in GitHub Actions, no local execution possible |
          | **Artifact re-verification** | All artifacts re-verified before apply |
          | **Policy re-evaluation** | Plan re-evaluated against policies |
          | **Fail-closed** | Any security violation blocks the workflow |
          | **Full traceability** | Complete audit trail from PR to apply |
          | **No manual bypass** | No emergency override or dev mode |

          ## Policy Gate Integration

          Apply workflow requires prior policy approval:
          - âœ… **Plan workflow** must complete successfully
          - âœ… **Policy evaluation** must pass in plan workflow
          - âœ… **Policy re-evaluation** must pass in apply workflow
          - âŒ **No bypass** mechanism exists

          See [docs/phase5/policy-engine.md](docs/phase5/policy-engine.md) for policy documentation.

          ## Explicit Non-Goals

          This workflow intentionally does NOT support:
          - âŒ Emergency override mechanisms
          - âŒ Dev mode bypass
          - âŒ Multi-environment apply (separate workflows per environment)
          - âŒ Local execution
          - âŒ Manual artifact creation

          ## Related Documentation

          - [docs/phase5/apply-workflow.md](docs/phase5/apply-workflow.md) - Complete apply workflow documentation
          - [docs/phase5/policy-engine.md](docs/phase5/policy-engine.md) - Policy engine documentation
          - [docs/phase4/terraform-plan-approval-workflow.md](docs/phase4/terraform-plan-approval-workflow.md) - Plan approval process
          - [docs/phase4/attestation-gate.md](docs/phase4/attestation-gate.md) - Attestation verification
          - [docs/phase4/security.md](docs/phase4/security.md) - Complete security boundaries
          EOF
