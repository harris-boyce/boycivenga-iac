name: Verify Attestations (Observation Only)

on:
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to verify (leave empty for latest)'
        required: false
        type: string
  # Run on schedule (e.g., weekly on Monday at 3 AM UTC)
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: read
  actions: read
  attestations: read   # Required for attestation verification

jobs:
  verify-attestations:
    runs-on: ubuntu-latest
    # Continue even if verification fails (observation only, non-blocking)
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          # GitHub CLI is pre-installed on ubuntu-latest runners
          gh --version

      - name: Determine workflow run to verify
        id: determine-run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ inputs.run_id }}" ]; then
            RUN_ID="${{ inputs.run_id }}"
            echo "Using manually specified run ID: $RUN_ID"
          else
            # Get the most recent successful render-artifacts workflow run
            RUN_ID=$(gh run list \
              --workflow render-artifacts.yaml \
              --status success \
              --limit 1 \
              --json databaseId \
              --jq '.[0].databaseId')

            if [ -z "$RUN_ID" ]; then
              echo "::error::No successful render-artifacts workflow runs found"
              exit 1
            fi

            echo "Using latest successful run ID: $RUN_ID"
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download artifacts to verify
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID="${{ steps.determine-run.outputs.run_id }}"

          echo "Downloading artifacts from run $RUN_ID..."

          # Create directories for artifacts
          mkdir -p artifacts/tfvars
          mkdir -p artifacts/unifi
          mkdir -p artifacts/intent-export

          # Download all artifact bundles
          gh run download "$RUN_ID" --dir artifacts-temp || true

          # Move files to expected locations
          if [ -d "artifacts-temp/terraform-tfvars" ]; then
            mv artifacts-temp/terraform-tfvars/* artifacts/tfvars/ 2>/dev/null || true
          fi

          if [ -d "artifacts-temp/unifi-configurations" ]; then
            mv artifacts-temp/unifi-configurations/* artifacts/unifi/ 2>/dev/null || true
          fi

          if [ -d "artifacts-temp/netbox-intent-export" ]; then
            mv artifacts-temp/netbox-intent-export/* artifacts/intent-export/ 2>/dev/null || true
          fi

          # Clean up temp directory
          rm -rf artifacts-temp

          echo "Artifacts downloaded successfully"
          echo ""
          echo "Artifact counts:"
          echo "  Terraform tfvars: $(ls -1 artifacts/tfvars/*.json 2>/dev/null | wc -l)"
          echo "  UniFi configs: $(ls -1 artifacts/unifi/*.json 2>/dev/null | wc -l)"
          echo "  NetBox exports (JSON): $(ls -1 artifacts/intent-export/*.json 2>/dev/null | wc -l)"
          echo "  NetBox exports (YAML): $(ls -1 artifacts/intent-export/*.yaml 2>/dev/null | wc -l)"

      - name: Verify Terraform tfvars attestations
        id: verify-tfvars
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "=== Verifying Terraform tfvars Attestations ==="
          echo ""

          VERIFIED=0
          FAILED=0
          TOTAL=0

          if [ ! -d "artifacts/tfvars" ] || [ -z "$(ls -A artifacts/tfvars/*.json 2>/dev/null)" ]; then
            echo "âš ï¸  No Terraform tfvars artifacts found to verify"
            echo "verified=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          for file in artifacts/tfvars/*.json; do
            TOTAL=$((TOTAL + 1))
            echo "Verifying: $(basename "$file")"

            if gh attestation verify "$file" \
                --owner ${{ github.repository_owner }} \
                --repo $(echo ${{ github.repository }} | cut -d'/' -f2) 2>&1; then
              echo "  âœ… Verification succeeded"
              VERIFIED=$((VERIFIED + 1))
            else
              echo "  âŒ Verification failed"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          done

          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "Summary: $VERIFIED/$TOTAL verified, $FAILED failed"

      - name: Verify UniFi configuration attestations
        id: verify-unifi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "=== Verifying UniFi Configuration Attestations ==="
          echo ""

          VERIFIED=0
          FAILED=0
          TOTAL=0

          if [ ! -d "artifacts/unifi" ] || [ -z "$(ls -A artifacts/unifi/*.json 2>/dev/null)" ]; then
            echo "âš ï¸  No UniFi configuration artifacts found to verify"
            echo "verified=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          for file in artifacts/unifi/*.json; do
            TOTAL=$((TOTAL + 1))
            echo "Verifying: $(basename "$file")"

            if gh attestation verify "$file" \
                --owner ${{ github.repository_owner }} \
                --repo $(echo ${{ github.repository }} | cut -d'/' -f2) 2>&1; then
              echo "  âœ… Verification succeeded"
              VERIFIED=$((VERIFIED + 1))
            else
              echo "  âŒ Verification failed"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          done

          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "Summary: $VERIFIED/$TOTAL verified, $FAILED failed"

      - name: Verify NetBox export JSON attestations
        id: verify-netbox-json
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "=== Verifying NetBox Export JSON Attestations ==="
          echo ""

          VERIFIED=0
          FAILED=0
          TOTAL=0

          if [ ! -d "artifacts/intent-export" ] || [ -z "$(ls -A artifacts/intent-export/*.json 2>/dev/null)" ]; then
            echo "âš ï¸  No NetBox JSON export artifacts found to verify"
            echo "verified=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          for file in artifacts/intent-export/*.json; do
            TOTAL=$((TOTAL + 1))
            echo "Verifying: $(basename "$file")"

            if gh attestation verify "$file" \
                --owner ${{ github.repository_owner }} \
                --repo $(echo ${{ github.repository }} | cut -d'/' -f2) 2>&1; then
              echo "  âœ… Verification succeeded"
              VERIFIED=$((VERIFIED + 1))
            else
              echo "  âŒ Verification failed"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          done

          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "Summary: $VERIFIED/$TOTAL verified, $FAILED failed"

      - name: Verify NetBox export YAML attestations
        id: verify-netbox-yaml
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "=== Verifying NetBox Export YAML Attestations ==="
          echo ""

          VERIFIED=0
          FAILED=0
          TOTAL=0

          if [ ! -d "artifacts/intent-export" ] || [ -z "$(ls -A artifacts/intent-export/*.yaml 2>/dev/null)" ]; then
            echo "âš ï¸  No NetBox YAML export artifacts found to verify"
            echo "verified=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          for file in artifacts/intent-export/*.yaml; do
            TOTAL=$((TOTAL + 1))
            echo "Verifying: $(basename "$file")"

            if gh attestation verify "$file" \
                --owner ${{ github.repository_owner }} \
                --repo $(echo ${{ github.repository }} | cut -d'/' -f2) 2>&1; then
              echo "  âœ… Verification succeeded"
              VERIFIED=$((VERIFIED + 1))
            else
              echo "  âŒ Verification failed"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          done

          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "Summary: $VERIFIED/$TOTAL verified, $FAILED failed"

      - name: Generate verification summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Attestation Verification Report ðŸ”

          **Note:** This is an observation-only workflow. Verification failures do not block operations.

          ## Verification Results

          | Artifact Type | Verified | Failed | Total |
          |---------------|----------|--------|-------|
          | Terraform tfvars | ${{ steps.verify-tfvars.outputs.verified || '0' }} | ${{ steps.verify-tfvars.outputs.failed || '0' }} | ${{ steps.verify-tfvars.outputs.total || '0' }} |
          | UniFi configs | ${{ steps.verify-unifi.outputs.verified || '0' }} | ${{ steps.verify-unifi.outputs.failed || '0' }} | ${{ steps.verify-unifi.outputs.total || '0' }} |
          | NetBox exports (JSON) | ${{ steps.verify-netbox-json.outputs.verified || '0' }} | ${{ steps.verify-netbox-json.outputs.failed || '0' }} | ${{ steps.verify-netbox-json.outputs.total || '0' }} |
          | NetBox exports (YAML) | ${{ steps.verify-netbox-yaml.outputs.verified || '0' }} | ${{ steps.verify-netbox-yaml.outputs.failed || '0' }} | ${{ steps.verify-netbox-yaml.outputs.total || '0' }} |

          ## What This Workflow Does

          This workflow demonstrates attestation verification for artifacts generated by the render pipeline:

          - âœ… Downloads artifacts from a workflow run
          - âœ… Verifies SLSA provenance attestations using `gh attestation verify`
          - âœ… Reports verification results
          - âš ï¸  **Non-blocking**: Failures are logged but do not fail the workflow

          ## Verified Run

          - **Run ID**: ${{ steps.determine-run.outputs.run_id }}
          - **Run URL**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.determine-run.outputs.run_id }}

          ## About Attestations

          Attestations provide cryptographic proof that artifacts:
          - Were generated by the trusted render-artifacts workflow
          - Have not been modified since generation
          - Can be traced to a specific commit and workflow run

          See [docs/phase3/attestation.md](../docs/phase3/attestation.md) for complete documentation.

          ## Troubleshooting

          If verification fails:
          1. Ensure artifacts were attested in the render-artifacts workflow
          2. Check that workflow permissions include `id-token: write` and `attestations: write`
          3. Verify artifacts have not been modified since download
          4. Review workflow logs for detailed error messages

          For more help, see the troubleshooting section in [docs/phase3/attestation.md](../docs/phase3/attestation.md).
          EOF

      - name: Final status
        if: always()
        run: |
          echo "=== Attestation Verification Complete ==="
          echo ""
          echo "This was an observation-only verification run."
          echo "Results have been logged for monitoring and audit purposes."
          echo ""
          echo "Total artifacts verified:"
          echo "  Terraform tfvars: ${{ steps.verify-tfvars.outputs.verified || '0' }}/${{ steps.verify-tfvars.outputs.total || '0' }}"
          echo "  UniFi configs: ${{ steps.verify-unifi.outputs.verified || '0' }}/${{ steps.verify-unifi.outputs.total || '0' }}"
          echo "  NetBox exports (JSON): ${{ steps.verify-netbox-json.outputs.verified || '0' }}/${{ steps.verify-netbox-json.outputs.total || '0' }}"
          echo "  NetBox exports (YAML): ${{ steps.verify-netbox-yaml.outputs.verified || '0' }}/${{ steps.verify-netbox-yaml.outputs.total || '0' }}"
