# Attestation Design & Scope Definition

## Purpose

This document defines the attestation strategy for Phase 3 of the infrastructure pipeline, specifying which artifacts will be attested and which are explicitly excluded from attestation. Attestation provides cryptographic proof of artifact provenance, ensuring that artifacts have not been tampered with and originate from trusted sources.

## Overview

Phase 3 introduces artifact attestation to improve supply chain security for the infrastructure-as-code pipeline. By attesting key artifacts, we can:

- **Verify artifact integrity**: Ensure artifacts have not been modified after generation
- **Establish provenance**: Prove artifacts were generated by trusted CI/CD workflows
- **Enable auditability**: Maintain cryptographic records of artifact generation
- **Support compliance**: Meet security requirements for infrastructure supply chain management

## Artifacts to be Attested

The following artifacts will be attested in Phase 3:

### 1. Terraform Input Files (tfvars)

**Files**: `artifacts/tfvars/*.tfvars.json`

**Description**: Site-specific Terraform variable files generated from NetBox intent data. These JSON files contain infrastructure configuration parameters that are consumed by Terraform modules.

**Example**:
- `site-pennington.tfvars.json`
- `site-countfleetcourt.tfvars.json`

**Rationale**: These files directly influence infrastructure deployment and should be verifiable to prevent unauthorized modifications between generation and application.

**Format**: JSON (`.tfvars.json`)

### 2. UniFi Configuration Payloads

**Files**: `artifacts/unifi/*.json`

**Description**: UniFi controller configuration files generated from NetBox intent data. These JSON payloads define network configurations including sites, networks, VLANs, and WLANs.

**Example**:
- `site-pennington.json`
- `site-countfleetcourt.json`

**Rationale**: These files represent intended network state and should be attested to ensure that network configurations applied to UniFi controllers are traceable to the automated pipeline.

**Format**: JSON (`.json`)

### 3. NetBox Intent Export Snapshots

**Files**: `artifacts/intent-export/*.json` and `artifacts/intent-export/*.yaml`

**Description**: Raw NetBox API export data including sites, prefixes, VLANs, and tags. This represents the source of truth for network intent at the time of artifact generation.

**Example**:
- `sites.json`
- `prefixes.json`
- `vlans.json`
- `tags.json`
- Corresponding `.yaml` files

**Rationale**: These exports serve as the authoritative source data for all downstream artifacts. Attesting these files provides an audit trail back to the original NetBox state and enables verification that rendered artifacts are derived from the correct source data.

**Format**: JSON and YAML (`.json`, `.yaml`)

## Explicitly Excluded Artifacts

The following artifacts are **NOT** attested in Phase 3:

### 1. Terraform Plan Files

**Path**: `terraform/**/*.tfplan` or any ephemeral plan outputs

**Rationale**:
- Terraform plan files are ephemeral and environment-specific
- Plans are not directly applied; they serve as previews only
- Plans may contain sensitive information that should not be persisted
- The *inputs* (tfvars) are attested instead, which is sufficient for provenance

### 2. Temporary or Intermediate Files

**Examples**:
- Workflow logs
- Debug outputs
- Temporary working directories
- Cache files

**Rationale**: These files are transient and not part of the final artifact set. They are automatically cleaned up or discarded after workflow execution.

### 3. Secrets and Credentials

**Examples**:
- API tokens
- Passwords
- Private keys
- Environment variable dumps containing sensitive data

**Rationale**: Secrets should never be attested or stored in version control. They are managed separately through GitHub Secrets or secure secret management systems.

### 4. Generated Documentation

**Examples**:
- `artifacts/SUMMARY.md`
- Markdown network topology summaries
- PR descriptions

**Rationale**: Documentation artifacts are informational only and do not directly affect infrastructure state. They are generated from attested data and can be regenerated if needed.

### 5. Git Metadata

**Examples**:
- `.git` directory contents
- Git hooks
- Commit history

**Rationale**: Git provides its own integrity mechanisms. Attesting Git metadata would be redundant and potentially confusing.

## Attestation Implementation

### Attestation Format

Attestations will use the [SLSA (Supply-chain Levels for Software Artifacts) Provenance](https://slsa.dev/provenance/) format, which is a widely adopted standard for supply chain security.

**Key Components**:
- **Subject**: The artifact being attested (e.g., `site-pennington.tfvars.json`)
- **Predicate**: SLSA Provenance metadata including:
  - Build type and builder information
  - Workflow trigger (manual, scheduled, push)
  - Timestamp and run ID
  - Materials (source repository commit SHA)
- **Signature**: Cryptographic signature using Sigstore/cosign

### Attestation Workflow Integration

Attestations will be generated during the `render-artifacts.yaml` workflow:

1. **Artifact Generation**: Existing steps generate tfvars, UniFi configs, and NetBox exports
2. **Attestation Generation**: New step generates SLSA provenance for each artifact
3. **Attestation Signing**: Provenance is signed using GitHub's OIDC token and Sigstore
4. **Attestation Upload**: Signed attestations are uploaded alongside artifacts

### Verification

Attestations can be verified by:
- CI/CD workflows before artifact consumption
- Manual verification using `cosign verify-attestation`
- Automated policy enforcement tools

## Long-term SLSA Level 3 Goal

### Current State (Phase 3)

Phase 3 establishes basic attestation capabilities, targeting **SLSA Level 2**:
- âœ… Provenance generation
- âœ… Hosted build platform (GitHub Actions)
- âœ… Build integrity (immutable workflow logs)

### Future State (Beyond Phase 3)

The long-term goal is to achieve **SLSA Level 3**, which requires:
- ðŸ”„ **Hardened build platform**: Use of GitHub-hosted runners with additional isolation
- ðŸ”„ **Non-falsifiable provenance**: Provenance generation integrated into the build service itself (not a separate workflow step)
- ðŸ”„ **Isolation**: Build environments are isolated from user-controlled inputs

**Path to SLSA Level 3**:
1. Adopt SLSA-compliant builders (e.g., `slsa-github-generator`)
2. Migrate from custom attestation steps to SLSA builder workflows
3. Implement build parameter isolation
4. Add policy-based verification gates before artifact deployment

**Timeline**: SLSA Level 3 is a multi-phase effort and is not a requirement for Phase 3 completion.

## Implementation Considerations

### Artifact Storage

- **Workflow Artifacts**: Attested artifacts and their attestations are uploaded as GitHub Actions artifacts (30-day retention)
- **Version Control**: Artifacts are committed to a PR branch for review but are not merged to main
- **Long-term Storage**: Consider implementing a dedicated artifact registry for long-term retention beyond GitHub Actions limits

### Performance Impact

- Attestation generation adds ~10-30 seconds to the workflow
- Signing operations are fast (<5 seconds per artifact)
- Minimal impact on overall pipeline duration

### Tooling

- **Sigstore/cosign**: Industry-standard keyless signing for attestations
- **GitHub OIDC**: No long-lived credentials required
- **SLSA Provenance**: Standard format for interoperability

## Next Steps

1. **Implement attestation generation** in `render-artifacts.yaml`
2. **Test attestation workflow** with sample artifacts
3. **Document verification procedures** for downstream consumers
4. **Add attestation verification** to deployment workflows (Phase 4)
5. **Monitor and iterate** based on operational feedback

## References

- [SLSA Framework](https://slsa.dev/)
- [Sigstore Project](https://www.sigstore.dev/)
- [GitHub Actions OIDC](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)
- [SLSA Provenance Specification](https://slsa.dev/provenance/v1)
