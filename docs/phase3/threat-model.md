# Phase 3 Threat Model & Provenance Documentation

## Overview

This document describes the security model for Phase 3 of the infrastructure pipeline, including what threats are mitigated, what threats are explicitly deferred, and the rationale for trust boundaries. Phase 3 introduces artifact attestation using SLSA provenance to establish cryptographic proof of artifact origin and integrity.

**Phase 3 Scope**: Supply chain security for artifact generation. The focus is on ensuring that artifacts generated by the render pipeline are authentic, traceable, and tamper-evident.

**Out of Scope for Phase 3**: Runtime execution security, deployment authorization, and infrastructure state protection are deferred to future phases.

## Executive Summary

Phase 3 establishes trust in the **artifact generation pipeline** by:
- âœ… Cryptographically attesting all artifacts with SLSA provenance
- âœ… Ensuring artifacts originate from trusted CI/CD workflows
- âœ… Detecting artifact tampering through digest verification
- âœ… Creating an audit trail for all artifact generation

Phase 3 explicitly **does not** protect against:
- âŒ Malicious or compromised deployment workflows
- âŒ Unauthorized Terraform/UniFi operations at runtime
- âŒ Compromised infrastructure automation agents
- âŒ NetBox data poisoning or unauthorized modifications

## Trust Boundaries

### Explicit Trust Boundaries in Phase 3

| Component | Trust Status | Rationale | Protection Mechanism |
|-----------|-------------|-----------|---------------------|
| **NetBox** | âœ… Trusted | Authoritative source of network intent; access-controlled via NetBox RBAC | API read-only token, NetBox internal access controls |
| **Render Pipeline** | âœ… Trusted (currently) | Runs in GitHub-hosted runners with immutable workflows; SLSA attestation enabled | GitHub OIDC identity, workflow immutability, attestation signing |
| **Generated Artifacts** | âœ… Trusted (with attestation) | SLSA provenance proves origin and integrity | SHA-256 digests, cryptographic signatures, GitHub Attestations API |
| **Terraform Runtime** | âŒ NOT Trusted | Runtime execution is not verified in Phase 3; deferred to future phases | Documentation-only requirement for attestation verification |
| **UniFi Controller** | âŒ NOT Trusted | Runtime application of configs is manual and unverified | Out of scope for Phase 3 |
| **Deployment Agents** | âŒ NOT Trusted | Future automation agents have not been secured | Not yet implemented |

### Trust Boundary Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRUSTED ZONE (Phase 3)                                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ NetBox   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Render Pipeline â”‚                    â”‚
â”‚  â”‚ (Intent) â”‚       â”‚ (GitHub Actions)â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚       â”‚                      â”‚                              â”‚
â”‚       â”‚                      â–¼                              â”‚
â”‚       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚       â”‚            â”‚ SLSA Attestationâ”‚                     â”‚
â”‚       â”‚            â”‚    (Sigstore)   â”‚                     â”‚
â”‚       â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚       â”‚                     â”‚                              â”‚
â”‚       â”‚                     â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   Attested Artifacts                 â”‚                 â”‚
â”‚  â”‚  - Terraform tfvars                  â”‚                 â”‚
â”‚  â”‚  - UniFi configs                     â”‚                 â”‚
â”‚  â”‚  - NetBox exports                    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                     â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Trust Boundary (Phase 3)
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UNTRUSTED ZONE (Phase 3)                                   â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Runtime Systems (NOT TRUSTED)   â”‚                      â”‚
â”‚  â”‚  - Terraform plan/apply         â”‚                      â”‚
â”‚  â”‚  - UniFi controller updates     â”‚                      â”‚
â”‚  â”‚  - Future automation agents     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Why NetBox is a Trusted Source of Intent

**Trust Status**: âœ… **Trusted**

### Rationale

NetBox is treated as the authoritative source of truth for network intent because:

1. **Explicit Design Decision**: NetBox is architected as a "source of truth" database for network infrastructure
2. **Access Control**: NetBox has its own authentication and authorization mechanisms (RBAC, API tokens)
3. **Audit Trail**: NetBox maintains change logs and user activity records
4. **Human Review**: Network intent changes in NetBox are subject to human review and approval processes
5. **Read-Only Access**: The render pipeline uses a read-only API token, limiting blast radius

### Trust Assumptions

For NetBox to remain trustworthy, the following assumptions must hold:

| Assumption | Required Control | Current State |
|------------|------------------|---------------|
| NetBox access is restricted to authorized users | NetBox RBAC, authentication | âœ… Assumed (managed outside this repository) |
| API tokens are read-only for render pipeline | NetBox token permissions | âœ… Enforced (documented requirement) |
| NetBox data is validated before entry | NetBox data validation, human review | âœ… Assumed (managed outside this repository) |
| NetBox instance is protected from unauthorized modification | NetBox infrastructure security | âœ… Assumed (managed outside this repository) |

### Risks Not Mitigated in Phase 3

Phase 3 **does not** protect against:
- **Data Poisoning**: Malicious or incorrect data entered into NetBox by authorized users
- **Compromised NetBox Instance**: If the NetBox server itself is compromised, all downstream artifacts are affected
- **API Token Compromise**: If the read-only API token is leaked, an attacker could read (but not modify) network intent

**Mitigation Strategy**: These risks are managed through NetBox-level security controls (authentication, authorization, audit logging) and organizational processes (data validation, change management). Future phases may add artifact validation rules to detect anomalous intent data.

## Why Render Pipelines are Trusted (Currently)

**Trust Status**: âœ… **Trusted** (with caveats)

### Rationale

The render pipeline (`.github/workflows/render-artifacts.yaml`) is trusted in Phase 3 because:

1. **GitHub-Hosted Runners**: Executes on GitHub's managed infrastructure with security hardening
2. **Immutable Workflows**: Workflow definitions are version-controlled and require code review to change
3. **SLSA Attestation**: All artifacts are cryptographically signed with GitHub OIDC identity
4. **Audit Trail**: GitHub Actions logs all workflow executions with immutable run IDs
5. **Limited Scope**: Pipeline is read-only and does not modify infrastructure or NetBox

### Trust Assumptions

For the render pipeline to remain trustworthy:

| Assumption | Required Control | Current State |
|------------|------------------|---------------|
| GitHub Actions infrastructure is secure | GitHub platform security | âœ… Assumed (GitHub-managed) |
| Workflow files cannot be modified without review | Branch protection, required reviews | âœ… Recommended (repository settings) |
| GitHub OIDC tokens are issued correctly | GitHub OIDC service | âœ… Assumed (GitHub-managed) |
| Render scripts are not malicious | Code review, testing | âœ… Enforced (PR review process) |
| Dependencies are not compromised | Dependency pinning, security scanning | âš ï¸ Partial (pinning recommended) |

### Risks Not Mitigated in Phase 3

Phase 3 **does not** protect against:
- **Compromised Workflow Files**: If an attacker gains write access to the repository and modifies workflow files, they can generate malicious artifacts (requires bypassing code review)
- **Dependency Poisoning**: Malicious Python packages could compromise artifact generation
- **GitHub Actions Compromise**: If GitHub's infrastructure is compromised, attestations may be untrustworthy
- **OIDC Token Theft**: If GitHub OIDC tokens are stolen, an attacker could forge attestations (highly difficult, short-lived tokens)

**Mitigation Strategy**:
- **Branch Protection**: Require code reviews for workflow changes
- **Dependency Pinning**: Pin Python dependencies to specific versions
- **Monitoring**: Review workflow run logs and attestation activity regularly

**Future Enhancement (SLSA Level 3)**: Migrate to a SLSA Level 3 compliant builder (e.g., `slsa-github-generator`) for non-falsifiable provenance, eliminating the trust requirement on workflow files.

## Why Runtime Systems are NOT Trusted in Phase 3

**Trust Status**: âŒ **NOT Trusted**

### Rationale

Runtime systems (Terraform, UniFi controllers, future automation agents) are explicitly **not trusted** in Phase 3 because:

1. **Out of Scope**: Phase 3 focuses on artifact generation, not runtime execution security
2. **Manual Deployment**: Artifact application is currently manual and unverified
3. **No Execution Control**: Phase 3 does not enforce who can run `terraform apply` or update UniFi controllers
4. **No Authorization**: No mechanism exists to verify that deployments are authorized
5. **Future Work**: Runtime security is deferred to Phase 4 and beyond

### Threat Scenarios

The following threats exist at runtime and are **not mitigated** in Phase 3:

| Threat | Description | Impact | Mitigation (Phase 3) |
|--------|-------------|--------|---------------------|
| **Unauthorized Deployment** | Attacker runs `terraform apply` with attested but unauthorized artifacts | Infrastructure changes applied without approval | âŒ None |
| **Artifact Substitution** | Attacker uses attested artifact from a different site or version | Wrong configuration applied to infrastructure | âŒ None |
| **Malicious Terraform Provider** | Compromised Terraform provider executes malicious code | Infrastructure compromise, data exfiltration | âŒ None |
| **UniFi Controller Compromise** | Attacker gains access to UniFi controller and applies malicious configs | Network misconfiguration, service disruption | âŒ None |
| **Stale Artifact Usage** | Old attested artifacts are applied to infrastructure | Infrastructure state drift, security vulnerabilities | âš ï¸ Partial (attestation timestamps) |
| **Manual Config Changes** | Operator bypasses attested artifacts and manually modifies infrastructure | Untracked changes, no audit trail | âŒ None |

### Trust Boundary at Runtime

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attested Artifact (TRUSTED)                           â”‚
â”‚  - Proven to originate from render pipeline           â”‚
â”‚  - SHA-256 digest verified                            â”‚
â”‚  - Commit SHA and timestamp available                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ TRUST GAP (Phase 3)
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Runtime Execution (UNTRUSTED)                         â”‚
â”‚  - No verification of who runs Terraform               â”‚
â”‚  - No verification of which artifacts are used         â”‚
â”‚  - No enforcement of deployment policies               â”‚
â”‚  - No protection against manual overrides             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Deferred Mitigations (Future Phases)

The following mitigations are planned for future phases:

| Mitigation | Phase | Description |
|------------|-------|-------------|
| **Policy Enforcement** | Phase 4 | Require attestation verification before Terraform execution |
| **Deployment Authorization** | Phase 4 | Implement approval workflow for infrastructure changes |
| **Artifact Freshness Checks** | Phase 4 | Reject artifacts older than a defined threshold |
| **Runtime Integrity Monitoring** | Phase 5 | Detect manual configuration changes and drift |
| **Agent Security** | Phase 5 | Secure automation agents with identity and authorization |

## Threat Coverage Matrix

### Threats Covered by Phase 3

| Threat | Mitigation | Effectiveness |
|--------|-----------|---------------|
| **Artifact Tampering** | SHA-256 digest verification via SLSA attestation | âœ… High (cryptographic) |
| **Artifact Forgery** | Cryptographic signatures using GitHub OIDC identity | âœ… High (keyless signing via Sigstore) |
| **Unknown Artifact Origin** | SLSA provenance includes workflow, commit SHA, timestamp | âœ… High (complete audit trail) |
| **Workflow Execution Tampering** | Immutable GitHub Actions logs, workflow run IDs | âœ… Medium (depends on GitHub platform) |
| **Unauthorized Workflow Modifications** | Version control, code review (recommended) | âš ï¸ Medium (depends on repository settings) |
| **Supply Chain Attacks (Pipeline)** | SLSA Level 2 attestation, workflow isolation | âš ï¸ Medium (SLSA Level 3 planned) |

### Threats Explicitly Deferred (Not Covered in Phase 3)

| Threat | Why Deferred | Planned Phase |
|--------|-------------|---------------|
| **Unauthorized Deployment** | Runtime execution is out of scope for Phase 3 | Phase 4 |
| **Stale Artifact Usage** | No policy enforcement mechanism exists yet | Phase 4 |
| **NetBox Data Poisoning** | Managed by NetBox-level controls | Future (TBD) |
| **Compromised Terraform Providers** | Terraform supply chain security is separate concern | Future (TBD) |
| **Manual Configuration Drift** | Runtime integrity monitoring not implemented | Phase 5 |
| **Unauthorized UniFi Changes** | UniFi security is manual and out of scope | Future (TBD) |
| **API Token Compromise** | Managed by secrets management and rotation | Ongoing (operational) |
| **GitHub Actions Compromise** | Platform security is managed by GitHub | N/A (GitHub-managed) |

### Threat Severity and Priority

| Threat Category | Severity | Phase 3 Coverage | Priority for Future Phases |
|-----------------|----------|------------------|---------------------------|
| **Artifact Integrity** | ğŸ”´ High | âœ… Fully Covered | N/A (complete) |
| **Artifact Provenance** | ğŸ”´ High | âœ… Fully Covered | N/A (complete) |
| **Pipeline Integrity** | ğŸŸ¡ Medium | âš ï¸ Partially Covered | High (SLSA Level 3) |
| **Runtime Authorization** | ğŸ”´ High | âŒ Not Covered | High (Phase 4) |
| **Data Validation** | ğŸŸ¡ Medium | âŒ Not Covered | Medium (Future) |
| **Configuration Drift** | ğŸŸ¡ Medium | âŒ Not Covered | Medium (Phase 5) |
| **Secrets Management** | ğŸ”´ High | âš ï¸ Partially Covered | High (Ongoing) |

## Attack Scenarios and Analysis

### Scenario 1: Attacker Attempts to Deploy Malicious Infrastructure

**Attack**: An attacker gains access to a workstation with Terraform installed and attempts to deploy malicious infrastructure.

**Phase 3 Protection**:
- âœ… Attacker cannot forge attested artifacts (requires GitHub OIDC token)
- âœ… Attacker cannot modify existing attested artifacts without detection (digest verification)

**Phase 3 Limitations**:
- âŒ Attacker can still run `terraform apply` with valid attested artifacts
- âŒ No authorization check prevents unauthorized deployment
- âŒ No policy enforcement prevents use of inappropriate artifacts

**Impact**: ğŸ”´ High (Infrastructure compromise possible)

**Mitigation Roadmap**: Phase 4 will add policy enforcement and deployment authorization.

---

### Scenario 2: Attacker Modifies Workflow to Generate Malicious Artifacts

**Attack**: An attacker with repository write access modifies the render pipeline workflow to inject malicious code.

**Phase 3 Protection**:
- âš ï¸ Branch protection and code review (if enabled) prevent direct workflow modification
- âš ï¸ All workflow changes are audited in Git history
- âœ… Modified workflow runs still produce attestations traceable to the modified commit SHA

**Phase 3 Limitations**:
- âŒ If attacker bypasses code review, they can generate malicious attested artifacts
- âŒ Attestations prove provenance but do not validate artifact content

**Impact**: ğŸ”´ High (Malicious artifacts with valid attestations)

**Mitigation Roadmap**:
- Immediate: Enforce branch protection and required reviews
- Phase 4: Implement artifact content validation rules
- Future: Migrate to SLSA Level 3 builder for non-falsifiable provenance

---

### Scenario 3: Attacker Compromises NetBox and Injects Malicious Intent

**Attack**: An attacker gains access to NetBox and modifies network intent data to include malicious configurations.

**Phase 3 Protection**:
- âœ… NetBox access controls and audit logs (external to this repository)
- âœ… Render pipeline uses read-only API token (cannot modify NetBox)

**Phase 3 Limitations**:
- âŒ No validation of NetBox data quality or safety
- âŒ Render pipeline trusts all NetBox data implicitly
- âŒ Malicious intent data results in malicious attested artifacts

**Impact**: ğŸ”´ High (Malicious intent becomes malicious infrastructure)

**Mitigation Roadmap**:
- Immediate: Harden NetBox access controls and monitoring
- Future: Implement artifact content validation rules (anomaly detection)

---

### Scenario 4: Attacker Steals NetBox API Token

**Attack**: An attacker obtains the read-only NetBox API token used by the render pipeline.

**Phase 3 Protection**:
- âœ… Token is read-only (cannot modify NetBox)
- âœ… Token is stored as GitHub secret (encrypted at rest)

**Phase 3 Limitations**:
- âŒ Attacker can read all network intent data (information disclosure)
- âŒ Attacker could generate artifacts locally using stolen token

**Impact**: ğŸŸ¡ Medium (Information disclosure, no direct infrastructure impact)

**Mitigation Roadmap**:
- Immediate: Rotate API tokens regularly
- Immediate: Monitor NetBox API access logs for anomalies
- Future: Implement IP allowlisting for NetBox API access

---

### Scenario 5: Attacker Replays Old Attested Artifacts

**Attack**: An attacker uses an old but valid attested artifact to deploy stale infrastructure configurations.

**Phase 3 Protection**:
- âš ï¸ Attestations include timestamps (can detect staleness)
- âš ï¸ Attestations include commit SHA (can trace to old code)

**Phase 3 Limitations**:
- âŒ No automatic freshness enforcement
- âŒ No policy preventing deployment of old artifacts

**Impact**: ğŸŸ¡ Medium (Infrastructure drift, potential security vulnerabilities)

**Mitigation Roadmap**:
- Phase 4: Implement artifact freshness policy (e.g., reject artifacts older than 7 days)

## SLSA Level Progression

### Current State: SLSA Level 2

Phase 3 achieves **SLSA Build Level 2**:

| Requirement | Status |
|-------------|--------|
| Build service | âœ… GitHub Actions (hosted) |
| Build as code | âœ… Workflow defined in version control |
| Provenance generation | âœ… Automatic attestation creation |
| Signed provenance | âœ… Keyless signing via Sigstore |
| Service-generated provenance | âœ… GitHub generates provenance metadata |

### Future State: SLSA Level 3

Long-term goal is **SLSA Build Level 3**:

| Requirement | Status | Planned Phase |
|-------------|--------|---------------|
| Hardened build platform | âŒ Not implemented | Future |
| Non-falsifiable provenance | âŒ Not implemented | Future (SLSA builder) |
| Isolation | âŒ Not implemented | Future |

**Path to SLSA Level 3**:
1. Adopt `slsa-github-generator` or equivalent SLSA Level 3 compliant builder
2. Migrate from custom attestation steps to SLSA builder workflows
3. Implement build parameter isolation
4. Add policy-based verification gates

## Security Best Practices for Phase 3

### For Operators

1. **Always Verify Attestations Before Deployment**
   ```bash
   gh attestation verify site-pennington.tfvars.json \
     --owner harris-boyce \
     --repo boycivenga-iac
   ```

2. **Check Artifact Freshness**
   - Review attestation timestamp before using artifacts
   - Prefer recent artifacts over stale ones
   - Investigate unexpected timestamp gaps

3. **Validate Commit SHA**
   - Ensure attested commit SHA matches expected workflow version
   - Review Git history for unexpected workflow changes

4. **Use Branch Protection**
   - Require code reviews for workflow changes
   - Enable required status checks
   - Restrict who can push to main branch

5. **Rotate API Tokens Regularly**
   - Rotate NetBox API tokens every 90 days
   - Monitor token usage in NetBox audit logs
   - Use different tokens for different environments

### For Developers

1. **Keep Render Scripts Deterministic**
   - Use `sort_keys=True` in JSON output
   - Avoid timestamps in generated content
   - Maintain stable ordering of data structures

2. **Pin Dependencies**
   - Pin Python package versions in workflow
   - Use `requirements.txt` with exact versions
   - Regularly update and test pinned versions

3. **Review Attestation Logs**
   - Monitor attestation generation for failures
   - Investigate attestation anomalies promptly
   - Verify attestations in CI verification workflow

4. **Test Locally Before Committing**
   - Test render scripts with example data
   - Verify output format and determinism
   - Run attestation verification after generation

## Compliance and Audit

### Audit Trail Components

Phase 3 provides the following audit trail:

| Component | Information | Retention |
|-----------|-------------|-----------|
| **GitHub Actions Logs** | Workflow execution details, render script output | 90 days |
| **SLSA Attestations** | Artifact provenance, commit SHA, timestamp | Indefinite (GitHub API) |
| **Sigstore Rekor Logs** | Public transparency log of all signatures | Indefinite (immutable) |
| **Git History** | Workflow file changes, code reviews | Indefinite |
| **NetBox Audit Logs** | Intent data changes (external) | Per NetBox retention policy |

### Compliance Use Cases

Phase 3 attestation supports:

1. **Change Tracking**: Trace every artifact to its source commit and workflow run
2. **Integrity Verification**: Prove artifacts have not been tampered with
3. **Access Auditing**: Review who triggered workflow runs (via GitHub logs)
4. **Security Incident Response**: Investigate artifact generation during incidents
5. **Regulatory Compliance**: Demonstrate supply chain security controls

### Audit Queries

**Example: Find all artifacts generated from a specific commit**
```bash
# List workflow runs for a commit
gh api /repos/harris-boyce/boycivenga-iac/actions/workflows/render-artifacts.yaml/runs \
  --jq ".workflow_runs[] | select(.head_sha == \"abc123def456\")"
```

**Example: Verify an artifact's provenance**
```bash
gh attestation verify site-pennington.tfvars.json \
  --owner harris-boyce \
  --repo boycivenga-iac \
  --format json | jq '.verificationResult.statement.predicate'
```

**Example: Check attestation timestamp**
```bash
gh attestation verify site-pennington.tfvars.json \
  --owner harris-boyce \
  --repo boycivenga-iac \
  --format json | jq '.verificationResult.statement.predicate.runDetails.metadata.finishedOn'
```

## Summary

### What Phase 3 Accomplishes

âœ… **Artifact Provenance**: Cryptographic proof of artifact origin  
âœ… **Integrity Protection**: Tamper detection via SHA-256 digests  
âœ… **Audit Trail**: Complete record of artifact generation  
âœ… **Supply Chain Security**: SLSA Level 2 attestation  
âœ… **Trust Boundary Definition**: Clear boundaries between trusted and untrusted components

### What Phase 3 Does Not Cover

âŒ **Runtime Authorization**: No enforcement of who can deploy artifacts  
âŒ **Policy Enforcement**: No automatic validation of artifact content  
âŒ **NetBox Security**: Data quality and access control managed externally  
âŒ **Deployment Security**: Terraform/UniFi operations are unverified  
âŒ **Configuration Drift**: No detection of manual infrastructure changes

### Key Takeaways

1. **Phase 3 secures the pipeline, not the runtime**: Artifacts are proven authentic, but deployment is uncontrolled
2. **Trust is layered**: NetBox and render pipeline are trusted; runtime systems are not
3. **Attestation is foundational**: Phase 3 establishes infrastructure for future security enhancements
4. **Manual verification is required**: Operators must verify attestations before deployment until automated enforcement is implemented
5. **Future phases will close gaps**: Runtime security and policy enforcement are planned for Phase 4 and beyond

## Related Documentation

- [attestation.md](./attestation.md) - SLSA provenance attestation implementation details
- [terraform-boundary.md](./terraform-boundary.md) - Terraform trust boundary contract
- [attestation-scope.md](./attestation-scope.md) - Attestation design and scope definition
- [artifact-integrity.md](./artifact-integrity.md) - Artifact identity and integrity specifications
- [../render-pipeline.md](../render-pipeline.md) - Complete render pipeline documentation
- [SLSA Framework](https://slsa.dev/) - Supply-chain security framework
- [Sigstore Documentation](https://docs.sigstore.dev/) - Keyless signing infrastructure

## Changelog

### Phase 3 Initial Implementation (2025-12-18)

- Created comprehensive threat model documentation
- Defined trust boundaries for NetBox, render pipeline, and runtime systems
- Documented covered vs. deferred threats with severity ratings
- Analyzed attack scenarios and mitigation strategies
- Provided audit trail and compliance guidance
- Established roadmap for future security enhancements
