# Terraform Trust Boundary Documentation

## Overview

This document defines the trust boundary contract for Terraform operations in this repository. The trust boundary ensures that Terraform consumes only cryptographically attested artifacts, preventing the application of unauthorized or tampered infrastructure configurations.

**Status**: This is a documentation-only requirement for Phase 3. Terraform plan/apply operations are not yet implemented in this repository.

## Trust Boundary Contract

### Primary Requirement

**Terraform MUST only consume attested artifacts.**

All artifacts intended for Terraform consumption (tfvars files, modules, etc.) must have valid SLSA provenance attestations before being used in any Terraform operation. This requirement applies to:

- `terraform plan` operations
- `terraform apply` operations
- Any automated or manual infrastructure deployment workflows
- All environments (development, staging, production)

### Rationale

Attesting artifacts provides:

1. **Provenance Verification**: Cryptographic proof that artifacts originate from trusted CI/CD workflows
2. **Integrity Protection**: Assurance that artifacts have not been modified after generation
3. **Supply Chain Security**: Protection against supply chain attacks and unauthorized modifications
4. **Audit Trail**: Complete record of artifact generation, including workflow run ID, commit SHA, and timestamp
5. **Compliance**: Meeting security requirements for infrastructure-as-code deployments

## Accepted Artifacts (With Attestation)

Artifacts with valid attestations are accepted for Terraform consumption. These artifacts have been generated by trusted workflows and cryptographically signed using GitHub OIDC identity and SLSA provenance.

### Example: Valid Attested Artifact

**Scenario**: A Terraform tfvars file generated by the render pipeline with attestation.

**Artifact**:
```
File: site-pennington.tfvars.json
Path: artifacts/tfvars/site-pennington.tfvars.json
SHA256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
```

**Attestation Verification**:
```bash
$ gh attestation verify artifacts/tfvars/site-pennington.tfvars.json \
  --owner harris-boyce \
  --repo boycivenga-iac

Loaded digest sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855 for file://artifacts/tfvars/site-pennington.tfvars.json
Loaded 1 attestation from GitHub API
✓ Verification succeeded!

sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855 was attested by:
REPO                            PREDICATE_TYPE                  WORKFLOW
harris-boyce/boycivenga-iac     https://slsa.dev/provenance/v1  .github/workflows/render-artifacts.yaml@refs/heads/main
```

**Result**: ✅ **ACCEPTED** - This artifact has a valid attestation and can be used by Terraform.

**SLSA Provenance Details**:
```json
{
  "subject": [
    {
      "name": "artifacts/tfvars/site-pennington.tfvars.json",
      "digest": {
        "sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
      }
    }
  ],
  "predicateType": "https://slsa.dev/provenance/v1",
  "predicate": {
    "buildDefinition": {
      "buildType": "https://actions.github.io/buildtypes/workflow/v1",
      "externalParameters": {
        "workflow": {
          "ref": "refs/heads/main",
          "repository": "https://github.com/harris-boyce/boycivenga-iac",
          "path": ".github/workflows/render-artifacts.yaml"
        }
      }
    },
    "runDetails": {
      "builder": {
        "id": "https://github.com/actions/runner/github-hosted"
      },
      "metadata": {
        "invocationId": "https://github.com/harris-boyce/boycivenga-iac/actions/runs/1234567890"
      }
    }
  }
}
```

### Characteristics of Accepted Artifacts

Accepted artifacts must meet all of the following criteria:

1. **Valid Attestation**: Artifact has an associated SLSA provenance attestation stored in GitHub Attestations API
2. **Digest Match**: The SHA-256 digest of the artifact matches the digest in the attestation
3. **Trusted Workflow**: Attestation references a trusted workflow (e.g., `.github/workflows/render-artifacts.yaml`)
4. **Signature Verification**: Attestation signature can be verified using GitHub OIDC identity
5. **Repository Match**: Attestation is from the correct repository (`harris-boyce/boycivenga-iac`)
6. **Freshness**: Artifact is from a recent workflow run (optional policy, not enforced in Phase 3)

## Rejected Artifacts (No Attestation)

Artifacts without valid attestations are rejected for Terraform consumption. This includes manually created files, artifacts from untrusted sources, or artifacts that have been modified after attestation.

### Example 1: No Attestation Found

**Scenario**: A manually created tfvars file that was never attested.

**Artifact**:
```
File: site-manual.tfvars.json
Path: /tmp/site-manual.tfvars.json
SHA256: a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
```

**Attestation Verification**:
```bash
$ gh attestation verify /tmp/site-manual.tfvars.json \
  --owner harris-boyce \
  --repo boycivenga-iac

Loaded digest sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2 for file:///tmp/site-manual.tfvars.json
✗ Verification failed!

Error: no attestations found for artifact
```

**Result**: ❌ **REJECTED** - This artifact has no attestation and MUST NOT be used by Terraform.

**Risk**: Using unattested artifacts introduces supply chain security risks:
- No proof of origin
- Cannot verify integrity
- May have been tampered with
- No audit trail

### Example 2: Modified Artifact (Digest Mismatch)

**Scenario**: An attested artifact that was modified after attestation.

**Artifact**:
```
File: site-pennington.tfvars.json (modified)
Path: artifacts/tfvars/site-pennington.tfvars.json
Original SHA256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
Modified SHA256: f4c1d55398fc2d259bfcf5d9007gc03538bf52f5750c045db506002c8963c966
```

**Attestation Verification**:
```bash
$ gh attestation verify artifacts/tfvars/site-pennington.tfvars.json \
  --owner harris-boyce \
  --repo boycivenga-iac

Loaded digest sha256:f4c1d55398fc2d259bfcf5d9007gc03538bf52f5750c045db506002c8963c966 for file://artifacts/tfvars/site-pennington.tfvars.json
Loaded 1 attestation from GitHub API
✗ Verification failed!

Error: artifact digest does not match attestation
Expected: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
Actual:   f4c1d55398fc2d259bfcf5d9007gc03538bf52f5750c045db506002c8963c966
```

**Result**: ❌ **REJECTED** - This artifact has been modified after attestation and MUST NOT be used by Terraform.

**Risk**: Modified artifacts indicate potential tampering:
- File content has changed since attestation
- Could be malicious modification
- Could be accidental corruption
- Violates integrity guarantee

### Example 3: Untrusted Workflow Source

**Scenario**: An attested artifact from an unauthorized or untrusted workflow.

**Artifact**:
```
File: site-untrusted.tfvars.json
Path: artifacts/tfvars/site-untrusted.tfvars.json
SHA256: b5d8c99417ed3e368dfdf6e8118id14649dg63g6861f156fb617113d9074d2c3
```

**Attestation Verification**:
```bash
$ gh attestation verify artifacts/tfvars/site-untrusted.tfvars.json \
  --owner harris-boyce \
  --repo boycivenga-iac

Loaded digest sha256:b5d8c99417ed3e368dfdf6e8118id14649dg63g6861f156fb617113d9074d2c3 for file://artifacts/tfvars/site-untrusted.tfvars.json
Loaded 1 attestation from GitHub API
✓ Signature verification succeeded

Warning: Attestation is from an unexpected workflow:
REPO                            PREDICATE_TYPE                  WORKFLOW
harris-boyce/boycivenga-iac     https://slsa.dev/provenance/v1  .github/workflows/manual-render.yaml@refs/heads/untrusted-branch
```

**Result**: ❌ **REJECTED** - This artifact is from an unauthorized workflow and MUST NOT be used by Terraform.

**Risk**: Artifacts from untrusted workflows may:
- Not follow required security controls
- Come from unreviewed code changes
- Bypass required approval processes
- Lack proper validation

### Characteristics of Rejected Artifacts

Artifacts are rejected if they exhibit any of the following:

1. **No Attestation**: No attestation exists for the artifact in GitHub Attestations API
2. **Digest Mismatch**: Artifact digest does not match the attested digest (indicating modification)
3. **Untrusted Workflow**: Attestation is from a workflow not on the approved list
4. **Untrusted Repository**: Attestation is from a different repository
5. **Invalid Signature**: Attestation signature cannot be verified
6. **Expired Certificate**: OIDC certificate used for signing has expired (rare)

## Enforcement

### Phase 3: Documentation Only

**Current State**: This trust boundary contract is documented but not yet enforced in automated workflows.

**Rationale**: Terraform plan/apply operations are not yet implemented in this repository. Phase 3 focuses on establishing attestation infrastructure and documenting requirements.

**What This Means**:
- Attestations are generated for all artifacts
- Verification tooling is available
- Trust boundary requirements are defined
- Enforcement will be implemented in future phases

### Future Phases: Automated Enforcement

**Planned Enforcement Mechanisms**:

1. **Pre-Terraform Verification Step**: Deployment workflows will verify attestations before running `terraform plan` or `terraform apply`
   ```yaml
   - name: Verify Artifact Attestations
     run: |
       for file in artifacts/tfvars/*.json; do
         gh attestation verify "$file" \
           --owner harris-boyce \
           --repo boycivenga-iac
       done
   ```

2. **Blocking Verification**: Verification failures will prevent Terraform operations from proceeding
   ```yaml
   - name: Verify Artifact Attestations
     run: |
       # Exit with error if verification fails
       set -e
       for file in artifacts/tfvars/*.json; do
         gh attestation verify "$file" \
           --owner harris-boyce \
           --repo boycivenga-iac
       done
   ```

3. **Policy Enforcement**: Additional policy checks can be implemented:
   - Workflow allowlist (only approved workflows)
   - Freshness checks (artifact not older than X days)
   - Branch restrictions (only from main branch)
   - Commit SHA validation (from reviewed commits)

4. **Audit Logging**: All verification attempts and results will be logged for compliance and incident response

## Integration with Deployment Workflows

### Recommended Workflow Structure (Future Implementation)

When Terraform deployment workflows are implemented, they should follow this structure:

```yaml
name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      render_run_id:
        description: 'Render artifacts workflow run ID'
        required: true
      site:
        description: 'Site to deploy (e.g., pennington, countfleetcourt)'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: read  # Required for attestation verification

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Terraform tfvars
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh run download ${{ inputs.render_run_id }} --name terraform-tfvars

      - name: Verify Attestations (REQUIRED)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # This step MUST NOT use continue-on-error
          # Verification failures MUST block deployment
          set -e
          
          echo "=== Verifying Artifact Attestations ==="
          for file in terraform-tfvars/*.json; do
            echo "Verifying: $file"
            gh attestation verify "$file" \
              --owner ${{ github.repository_owner }} \
              --repo $(echo ${{ github.repository }} | cut -d'/' -f2)
          done
          
          echo "✓ All attestations verified successfully"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file=terraform-tfvars/site-${{ inputs.site }}.tfvars.json \
            -out=tfplan

      - name: Terraform Apply
        if: github.event_name == 'workflow_dispatch'
        run: terraform apply tfplan
```

**Key Points**:
- Attestation verification is a **required** step (no `continue-on-error`)
- Verification must succeed before Terraform operations
- Uses official `gh attestation verify` for consistency
- Logs verification results for audit trail

## PR Merge Requirements

### Trust Boundary Protection

**Requirement**: No un-attested artifact can be merged to the main branch.

**Implementation**:

1. **Artifact Generation**: All artifacts in PRs must be generated by the render pipeline workflow
2. **Attestation Required**: All artifacts must have valid attestations before PR approval
3. **Verification in CI**: PR checks should verify attestations (future implementation)
4. **Manual Review**: Reviewers must confirm artifacts have attestations

### PR Checklist

When reviewing pull requests that include artifacts, verify:

- [ ] All artifacts were generated by the official render pipeline workflow
- [ ] Artifacts have valid SLSA provenance attestations
- [ ] Attestations can be verified using `gh attestation verify`
- [ ] No manually created or modified artifacts are included
- [ ] Workflow run ID is documented in the PR description
- [ ] Commit SHA matches the attestation metadata

### Verification Process for Reviewers

**Step 1: Identify Artifacts in PR**
```bash
# List artifact files in the PR
git diff main...feature-branch --name-only | grep 'artifacts/'
```

**Step 2: Get Workflow Run ID**
- Check PR description for workflow run ID
- Or check the most recent render-artifacts workflow run:
  ```bash
  gh run list --workflow render-artifacts.yaml --limit 5
  ```

**Step 3: Download and Verify**
```bash
# Download artifacts from the workflow run
gh run download <run-id> --name terraform-tfvars

# Verify each artifact
for file in terraform-tfvars/*.json; do
  gh attestation verify "$file" \
    --owner harris-boyce \
    --repo boycivenga-iac
done
```

**Step 4: Approve or Request Changes**
- ✅ Approve if all attestations verify successfully
- ❌ Request changes if any verification fails
- ❌ Reject if manual/unattested artifacts are present

## Verification Tools and Resources

### GitHub CLI (`gh`)

The primary tool for attestation verification:

```bash
# Verify a single artifact
gh attestation verify <path-to-artifact> \
  --owner harris-boyce \
  --repo boycivenga-iac

# Verify with JSON output
gh attestation verify <path-to-artifact> \
  --owner harris-boyce \
  --repo boycivenga-iac \
  --format json
```

**Installation**:
```bash
# macOS
brew install gh

# Linux
# See https://github.com/cli/cli/blob/trunk/docs/install_linux.md

# Verify version (requires 2.49.0 or later)
gh --version
```

### Verification Scripts

Helper scripts for batch verification:

```bash
#!/bin/bash
# verify-all-tfvars.sh

set -e

OWNER="harris-boyce"
REPO="boycivenga-iac"

echo "=== Verifying All Terraform tfvars ==="

VERIFIED=0
FAILED=0

for file in artifacts/tfvars/*.json; do
    if [ -f "$file" ]; then
        echo "Verifying: $(basename "$file")"
        if gh attestation verify "$file" --owner "$OWNER" --repo "$REPO" > /dev/null 2>&1; then
            echo "  ✓ Verified"
            VERIFIED=$((VERIFIED + 1))
        else
            echo "  ✗ Failed"
            FAILED=$((FAILED + 1))
        fi
    fi
done

echo ""
echo "=== Summary ==="
echo "Verified: $VERIFIED"
echo "Failed: $FAILED"

if [ $FAILED -gt 0 ]; then
    echo ""
    echo "ERROR: Some artifacts failed verification"
    exit 1
fi

echo "✓ All artifacts verified successfully"
```

### Automated Verification Workflow

The repository includes a verification workflow (`.github/workflows/verify-attestation.yaml`) that:
- Runs weekly to verify all artifacts
- Can be triggered manually
- Provides verification summaries
- Logs all verification results

**Usage**:
```bash
# Trigger manual verification
gh workflow run verify-attestation.yaml

# Trigger with specific run ID
gh workflow run verify-attestation.yaml -f run_id=1234567890
```

## Related Documentation

- [attestation.md](./attestation.md) - Complete SLSA provenance attestation implementation guide
- [artifact-integrity.md](./artifact-integrity.md) - Artifact identity and integrity specifications
- [attestation-scope.md](./attestation-scope.md) - Attestation design and scope definition
- [../render-pipeline.md](../render-pipeline.md) - Render pipeline documentation
- [SLSA Framework](https://slsa.dev/) - Supply-chain security framework
- [GitHub Attestations](https://docs.github.com/en/actions/security-guides/using-artifact-attestations-to-establish-provenance-for-builds) - GitHub attestation documentation

## Summary

The Terraform trust boundary establishes a critical security control: **Terraform must only consume attested artifacts**. This requirement:

- ✅ Ensures artifact provenance and integrity
- ✅ Protects against supply chain attacks
- ✅ Provides complete audit trails
- ✅ Supports compliance requirements
- ✅ Prevents unauthorized infrastructure changes

**Phase 3 Status**: Documentation complete. Enforcement will be implemented when Terraform deployment workflows are added in future phases.

**Acceptance Criteria Met**:
- [x] Document "Terraform must only consume attested artifacts" requirement
- [x] Provide example of accepted artifacts (with attestation)
- [x] Provide example of rejected artifacts (no attestation)
- [x] Define PR merge requirements for attested artifacts
- [x] Document verification tools and processes
